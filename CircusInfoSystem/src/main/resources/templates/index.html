<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Информационно-справочная система цирка</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqul2QvZ6jiW3" crossorigin="anonymous">
    <!--библиотека-->
    <!--тут рамки белые убрала-->
    <style>
        body, html {
            margin: 0;
            padding: 0;
        }
        .bg-image {
            background-image: url('/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            height: 100vh;
            width: 100%;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-container {
            background-color: rgba(255, 255, 255, 0.3);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 900px;
        }
    </style>
</head>
<body>
<div class="bg-image">
    <div class="container">
        <div class="form-container">
                <blockquote class="blockquote text-center"><h1>Артисты нашего цирка</h1></blockquote>
            <div class="row">
                <div class="col-md-8 offset-md-4">
                    <h4>Поиск актера по любому критерию:</h4>
                    <form th:action="@{/}">
                        <input type="text" name="keyword" id="keyword" size="35" th:value="${keyword}" required/>
                        <input type="submit" class="btn btn-success btn-sm" value="Поиск"/>
                        <input type="button" class="btn btn-warning btn-sm" value="Очистить" id="btnClear"
                               onclick="clearSearch()"/>
                    </form>
                </div>
            </div>
            <table id="1" class="table table-striped table-hover">
                <thead>
                <tr>
                    <th scope="col">
                        <a th:href="@{/(sortField='id', sortDir=${sortDir == 'asc' && sortField == 'id' ? 'desc' : 'asc'}, keyword=${keyword})}"
                           class="text-white text-decoration-none">
                            ID артиста
                            <span th:if="${sortField == 'id'}" th:text="${sortDir == 'asc' ? '↑' : '↓'}"></span>
                        </a>
                    </th>
                    <th scope="col">
                        <a th:href="@{/(sortField='fullName', sortDir=${sortDir == 'asc' && sortField == 'fullName' ? 'desc' : 'asc'}, keyword=${keyword})}"
                           class="text-white text-decoration-none">
                            Имя
                            <span th:if="${sortField == 'fullName'}" th:text="${sortDir == 'asc' ? '↑' : '↓'}"></span>
                        </a>
                    </th>
                    <th scope="col">
                        <a th:href="@{/(sortField='speciality', sortDir=${sortDir == 'asc' && sortField == 'speciality' ? 'desc' : 'asc'}, keyword=${keyword})}"
                           class="text-white text-decoration-none">
                            Специальность
                            <span th:if="${sortField == 'speciality'}" th:text="${sortDir == 'asc' ? '↑' : '↓'}"></span>
                        </a>
                    </th>
                    <th scope="col">
                        <a th:href="@{/(sortField='yearsExperience', sortDir=${sortDir == 'asc' && sortField == 'yearsExperience' ? 'desc' : 'asc'}, keyword=${keyword})}"
                           class="text-white text-decoration-none">
                            Стаж
                            <span th:if="${sortField == 'yearsExperience'}"
                                  th:text="${sortDir == 'asc' ? '↑' : '↓'}"></span>
                        </a>
                    </th>
                    <th scope="col" sec:authorize="hasRole('ADMIN')">Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="performer: ${listPerformers}">
                    <th scope="row" class="text-white" th:text="${performer.id}"></th>
                    <th scope="row" class="text-white" th:text="${performer.fullName}"></th>
                    <th scope="row" class="text-white" th:text="${performer.speciality}"></th>
                    <th scope="row" class="text-white" th:text="${performer.yearsExperience}"></th>
                    <td sec:authorize="hasRole('ADMIN')">
                        <a th:href="@{'/edit/'+${performer.id}}">
                            <button type="button" class="btn btn-info">Редактировать</button>
                        </a>
                        <a th:href="@{'/delete/'+${performer.id}}">
                            <button type="button" class="btn btn-danger">Удалить</button>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
            <p class="text-white">
                <script type="text/javascript">
                    window.addEventListener('DOMContentLoaded', function () {
                        let table = document.getElementById('1')
                        let tBody = table.querySelector('tbody')
                        const count = tBody.querySelectorAll('tr').length;
                        document.getElementById('count').innerText = 'Количество артистов в таблице: ' + count;
                    });
                </script>
            </p>
            <p id="count" class="text-white">Количество артистов в таблице: 0</p>
            <button id="toggleChartBtn" class="btn btn-outline-light btn-sm mt-3">Гистограмма ▼</button>
            <!--кнопка переключения гистограммы-->
            <div id="chartContainer"
                 style="display: none; margin-top: 20px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px;">
                <canvas id="stajHistogram" width="600" height="300"></canvas>
            </div> <!--тут контейнер гля гистограммы (изначально скрыт)-->
            <blockquote class="blockquote text-center">
                <a href="/timetable">
                    <button type="button" class="btn btn-outline-light">
                        Посмотреть расписание
                    </button>
                </a>
            </blockquote>
            <blockquote class="blockquote text-center" sec:authorize="hasRole('ADMIN')">
                <a href="/new">
                    <button type="button" class="btn btn-primary" data-togge="button" aria-pressed="false"
                            autocomplete="off">
                        Добавить артиста
                    </button>
                </a>
            </blockquote>
            <blockquote class="blockquote text-center">
                <a href="/about">
                    <button type="button" class="btn btn-outline-light">
                        Об авторе
                    </button>
                </a>
            </blockquote>
            <div class="mt-4 d-flex justify-content-end">
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="btn btn-outline-danger btn-sm">Выход</button>
                </form>
            </div>
        </div>
        <script type="text/javascript"> <!--функция очистки поля-->
        function clearSearch() {
            window.location = "[[@{/}]]";
        }
        </script>
        <!--скрытые данные для гистограммы-->
        <script th:inline="javascript">
            /*<![CDATA[*/
            const performerNames = [];
            const performerStaj = [];

            // заполняем массивы из данных таблицы
            document.querySelectorAll('tbody tr').forEach(row => {
                const name = row.querySelector('th:nth-child(2)').innerText;
                const staj = parseFloat(row.querySelector('th:nth-child(4)').innerText);
                if (!isNaN(staj)) {
                    performerNames.push(name);
                    performerStaj.push(staj);
                }
            });
            /*]]>*/
        </script>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script> // переключение видимости гистограммы
    document.getElementById('toggleChartBtn').addEventListener('click', function () {
        const container = document.getElementById('chartContainer');
        const isVisible = container.style.display === 'block';
        container.style.display = isVisible ? 'none' : 'block';
        this.textContent = isVisible ? 'Гистограмма ▼' : 'Гистограмма ▲';

        // если гистограмма стала видимой — перестроить её
        if (!isVisible) {
            renderHistogram();
        }
    });

    //отрисовка гистограммы
    function renderHistogram() {
        const ctx = document.getElementById('stajHistogram').getContext('2d');

        // очистить предыдущий график
        if (window.histogramChart) {
            window.histogramChart.destroy();
        }

        // создать гистограмму
        window.histogramChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: performerNames,
                datasets: [{
                    label: 'Стаж (лет)',
                    data: performerStaj,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Стаж (лет)'
                        },
                        min: 0,
                        max: 30,
                        ticks: {
                            stepSize: 5
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Артисты'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: 'white'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Стаж артистов',
                        color: 'white'
                    }
                }
            }
        });
    }

    window.addEventListener('DOMContentLoaded', function () {
        let table = document.getElementById('1');
        let tBody = table.querySelector('tbody');
        const count = tBody.querySelectorAll('tr').length;
        document.getElementById('count').innerText = 'Количество артистов в таблице: ' + count;
    });
    </script>
</body>
</html>


